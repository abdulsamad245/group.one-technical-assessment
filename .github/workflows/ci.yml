name: CI/CD Pipeline

on:
  push:
    branches: [ "develop", "main" ]
  pull_request:
    branches: [ "develop", "main" ]

jobs:
  laravel-ci:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: testing
        ports:
          - 3307:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      DB_CONNECTION: sqlite
      DB_DATABASE: ':memory:'
      APP_KEY: ${{ secrets.APP_KEY }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, bcmath, pdo, sqlite
          ini-values: post_max_size=256M, memory_limit=2G

      - name: Install Dependencies
        run: |
          curl -sS https://getcomposer.org/installer | php -- --version=2.7.6
          sudo mv composer.phar /usr/local/bin/composer
          composer install --no-interaction --prefer-dist

      - name: Copy .env and set APP_KEY
        run: |
          php -r "file_exists('.env') || copy('.env.example', '.env');"
          echo "APP_KEY=${{ secrets.APP_KEY }}" >> .env

      - name: Start Sail
        run: ./vendor/bin/sail up -d

      - name: Wait for MySQL
        run: |
          until ./vendor/bin/sail exec -T mysql mysqladmin ping -h"mysql" --silent; do
            echo "Waiting for database..."
            sleep 5
          done

      - name: Run Migrations
        run: ./vendor/bin/sail artisan migrate --force

      - name: Validate Pull Request Description
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const description = context.payload.pull_request.body;
            if (!description || description.length < 20) {
              throw new Error("PR description is too short or empty.");
            }

      - name: Check PR Task List Completion
        if: github.event_name == 'pull_request' && (github.event.action == 'edited' || github.event.action == 'opened' || github.event.action == 'synchronize' || github.event.action == 'reopened')
        uses: wp-media/pr-checklist-action@master
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Execute Tests
        run: ./vendor/bin/sail test

      - name: Generate Coverage Report
        run: ./vendor/bin/sail php vendor/bin/phpunit --coverage-clover=tests/report/coverage.xml

      - name: Install diff-cover
        run: pip install diff-cover

      - name: Run Diff Coverage
        run: |
          diff-cover tests/report/coverage.xml --compare-branch=origin/main --fail-under=50

      - name: Lint and Run Static Analysis
        run: |
          composer lint      
          composer phpstan    

      - name: Upload Coverage to Codacy
        if: github.event_name == 'push' || github.event_name == 'pull_request'
        uses: codacy/codacy-coverage-reporter-action@v1
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          coverage-reports: tests/report/coverage.xml
