name: CI/CD Pipeline

on:
  push:
    branches: [ "develop", "main" ]
  pull_request:
    branches: [ "develop", "main" ]

jobs:
  laravel-ci:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: testing
        ports:
          - 3307:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: testing
      DB_USERNAME: root
      DB_PASSWORD: password
      APP_KEY: ${{ secrets.APP_KEY }}

    steps:
      # 1. Checkout code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Setup PHP
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, bcmath, mysql, pdo_mysql
          ini-values: post_max_size=256M, memory_limit=2G

      # 3. Install composer dependencies
      - name: Install Dependencies
        run: |
          curl -sS https://getcomposer.org/installer | php -- --version=2.7.6
          sudo mv composer.phar /usr/local/bin/composer
          composer install --no-interaction --prefer-dist

      # 4. Copy .env and set APP_KEY
      - name: Copy .env and set APP_KEY
        run: |
          php -r "file_exists('.env') || copy('.env.example', '.env');"
          echo "APP_KEY=${{ secrets.APP_KEY }}" >> .env

      # 5. Start Laravel Sail
      - name: Start Sail
        run: ./vendor/bin/sail up -d

      # 6. Wait for MySQL
      - name: Wait for MySQL
        run: |
          until ./vendor/bin/sail exec -T mysql mysqladmin ping -h"mysql" --silent; do
            echo "Waiting for database..."
            sleep 5
          done

      # 7. Run migrations & seeders
      - name: Set Up Database
        run: ./vendor/bin/sail artisan migrate --seed --force

      # 8. Validate Pull Request Description
      - name: Validate Pull Request Description
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const description = context.payload.pull_request.body;
            if (!description || description.length < 20) {
              throw new Error("PR description is too short or empty.");
            }

      # 9. Check PR Task List Completion using wp-media/pr-checklist-action
      - name: Check PR Task List Completion
        if: github.event_name == 'pull_request'
        uses: wp-media/pr-checklist-action@master
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      # 10. Run unit & integration tests
      - name: Execute Tests
        run: ./vendor/bin/sail test

      # 11. Generate code coverage report
      - name: Generate Coverage Report
        run: ./vendor/bin/sail php vendor/bin/phpunit --coverage-clover=tests/report/coverage.xml

      # 12. Install diff-cover
      - name: Install diff-cover
        run: pip install diff-cover

      # 13. Run diff coverage (fail if under 50%)
      - name: Run Diff Coverage
        run: |
          diff-cover tests/report/coverage.xml --compare-branch=origin/develop --fail-under=50

      # 14. Run Static Analysis Only (temporarily disabled PHPCS & Pint)
      - name: Run Static Analysis Only
        run: |
          # composer lint      
          composer phpstan    

      # 15. Upload coverage to Codacy
      - name: Upload Coverage to Codacy
        if: github.event_name == 'push' || github.event_name == 'pull_request'
        uses: codacy/codacy-coverage-reporter-action@v1
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          coverage-reports: tests/report/coverage.xml
